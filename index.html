<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pobočky – mapa</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; }

    .badge { display:inline-block; padding:.15rem .5rem; border-radius:999px; font-size:12px; }
    .open   { background:#d7f5e3; }
    .closed { background:#f1f1f1; }
    .plan   { background:#e5e7eb; }

    .legend {
      position: absolute; z-index: 1000; right: 12px; top: 12px;
      background: rgba(255,255,255,.92); border-radius: 12px;
      padding: 10px 12px; font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      box-shadow: 0 4px 18px rgba(0,0,0,.12);
    }
    .legend .row { display:flex; align-items:center; gap:8px; margin:6px 0; }
    .dot { width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,.2); }
    .dot.open { background:#22c55e; }
    .dot.closed { background:#9ca3af; }
    .dot.plan { background:#6b7280; outline: 2px dashed rgba(0,0,0,.25); outline-offset: 2px; }
    a { color: #0b57d0; }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="legend">
    <strong>Pobočky</strong>
    <div class="row"><span class="dot open"></span> Otevřeno</div>
    <div class="row"><span class="dot closed"></span> Zavřeno</div>
    <div class="row"><span class="dot plan"></span> Plánuje se</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ====== DATA POBOČEK ======
    // URL podle tvého zadání: plodyzeme.cz/#město (používám slug bez diakritiky)
    const BASE_URL = "https://plodyzeme.cz/#";

    const branches = [
      {
        name: "Prodejna Trutnov",
        addr: "Palackého 78, 541 01 Trutnov",
        url: BASE_URL + "trutnov",
        lat: 50.56075379808682, lng: 15.911718414822795,
        hours: { po:"10:00-18:00", ut:"10:00-18:00", st:"10:00-18:00", ct:"10:00-18:00", pa:"10:00-18:00", so:"closed", ne:"closed" }
      },
      {
        name: "Prodejna Náchod",
        addr: "Náchod (střed) – plánuje se",
        url: BASE_URL + "nachod",
        lat: 50.4167, lng: 16.1629, // střed města
        planned: true
      },
      {
        name: "Prodejna Hradec Králové",
        addr: "Gočárova tř. 312/52, 500 02 Hradec Králové",
        url: BASE_URL + "hradec-kralove",
        lat: 50.21197053673083, lng: 15.810996169139326,
        hours: { po:"11:00-19:00", ut:"11:00-19:00", st:"11:00-19:00", ct:"11:00-19:00", pa:"11:00-19:00", so:"closed", ne:"closed" }
      },
      {
        name: "Prodejna Pardubice",
        addr: "J. Palacha 1253, 530 02 Pardubice",
        url: BASE_URL + "pardubice",
        lat: 50.02578872364449, lng: 15.770669997737803,
        hours: { po:"11:00-19:00", ut:"11:00-19:00", st:"11:00-19:00", ct:"11:00-19:00", pa:"11:00-19:00", so:"closed", ne:"closed" }
      },
      {
        name: "Prodejna Chrudim",
        addr: "Resselovo nám. 2, 537 01 Chrudim",
        url: BASE_URL + "chrudim",
        lat: 49.95178201451212, lng: 15.794964737952599,
        hours: { po:"10:00-18:00", ut:"10:00-18:00", st:"10:00-18:00", ct:"10:00-18:00", pa:"10:00-18:00", so:"closed", ne:"closed" }
      }
    ];

    // ====== ČAS V EUROPE/PRAGUE ======
    const weekdayKey = (wdShort) => {
      // Intl cs-CZ vrací např. "po", "út", "st", "čt", "pá", "so", "ne"
      // pro jistotu normalizace bez teček a do lowercase
      const s = (wdShort || "").toLowerCase().replace(".", "");
      if (s.startsWith("po")) return "po";
      if (s.startsWith("út") || s.startsWith("ut")) return "ut";
      if (s.startsWith("st")) return "st";
      if (s.startsWith("čt") || s.startsWith("ct")) return "ct";
      if (s.startsWith("pá") || s.startsWith("pa")) return "pa";
      if (s.startsWith("so")) return "so";
      if (s.startsWith("ne")) return "ne";
      return "po";
    };

    function nowInPragueParts() {
      const parts = new Intl.DateTimeFormat("cs-CZ", {
        timeZone: "Europe/Prague",
        hour: "2-digit",
        minute: "2-digit",
        weekday: "short",
        hour12: false
      }).formatToParts(new Date());

      const get = (t) => parts.find(p => p.type === t)?.value;
      return {
        hh: Number(get("hour")),
        mm: Number(get("minute")),
        wd: weekdayKey(get("weekday"))
      };
    }

    function isOpenNow(hoursByDay) {
      if (!hoursByDay) return { state: "closed", note: "Bez otevíračky" };

      const { hh, mm, wd } = nowInPragueParts();
      const today = hoursByDay[wd];
      if (!today || today === "closed") return { state: "closed", note: "Dnes zavřeno" };

      const [openS, closeS] = today.split("-").map(s => s.trim());
      const [oh, om] = openS.split(":").map(Number);
      const [ch, cm] = closeS.split(":").map(Number);

      const now = hh * 60 + mm;
      const open = oh * 60 + om;
      const close = ch * 60 + cm;

      // (kdybys někdy měl otevíračku přes půlnoc, je tu podpora)
      const openNow = (open <= close) ? (now >= open && now <= close) : (now >= open || now <= close);
      return { state: openNow ? "open" : "closed", note: today };
    }

    // ====== IKONKY ======
const SHOP_SVG = `
<svg
  viewBox="0 0 16.365271 16.26227"
  xmlns="http://www.w3.org/2000/svg"
  preserveAspectRatio="xMidYMid meet"
  style="width:100%; height:100%; display:block;"
><g
     inkscape:label="Layer 1"
     inkscape:groupmode="layer"
     id="layer1"
     transform="translate(-109.09127,-138.01987)"><g
       id="g10"
       transform="matrix(0.86340732,0,0,0.86340732,16.018757,19.963157)"><path
         style="fill:#000000;fill-opacity:1"
         d="m 116.41335,154.02197 h 2.83772 l 0.2416,-0.27785 0.24161,-0.27785 0.55033,-1.16033 0.55033,-1.16032 0.11253,-0.001 0.11252,-0.001 1.43576,1.43934 1.43575,1.43933 h 0.63189 0.63189 v -0.31698 -0.31698 l -2.51204,-2.51308 -2.51204,-2.51309 0.2638,-0.6201 0.2638,-0.6201 0.60599,-1.35467 0.606,-1.35467 0.16057,-0.40307 0.16058,-0.40308 v -0.21963 -0.21963 l -0.19841,-0.39329 -0.19841,-0.3933 -0.54821,-0.97366 -0.54821,-0.97367 -0.58208,-1.07724 -0.58208,-1.07725 -0.0186,0.0189 -0.0186,0.0189 -0.6068,1.39541 -0.6068,1.39541 -0.17423,0.38246 -0.17423,0.38247 -0.28463,0.67489 -0.28464,0.67489 v 0.32344 0.32344 l 0.18084,0.35647 0.18083,0.35646 0.50076,0.83558 0.50077,0.83559 -0.0263,0.13808 -0.0263,0.13808 -0.20335,0.0289 -0.20335,0.0289 -1.65845,-1.69623 -1.65845,-1.69624 -0.45987,-0.13178 -0.45987,-0.13178 h -2.31296 -2.31297 v 0.064 0.064 l 1.01895,1.22713 1.01896,1.22713 0.58989,0.6906 0.5899,0.69061 0.3959,0.13489 0.3959,0.1349 h 1.5785 1.5785 l 0.41725,0.1398 0.41725,0.1398 1.16416,1.15241 1.16417,1.15241 -0.003,0.25296 -0.003,0.25295 -0.10314,0.13434 -0.10314,0.13434 -0.18493,0.0985 -0.18494,0.0985 h -0.9826 -0.98261 l -0.34983,0.17847 -0.34983,0.17847 -1.47728,1.47253 -1.47728,1.47253 z"
         id="path4" /><path
         style="fill:#000000;fill-opacity:1"
         d="m 116.38745,154.27597 h -2.93261 l -0.0564,-0.0565 -0.0564,-0.0564 v -0.11784 -0.11784 l 1.57453,-1.56345 1.57452,-1.56344 0.26697,-0.14217 0.26697,-0.14217 1.16745,-0.0463 1.16744,-0.0463 0.0801,-0.127 0.0801,-0.127 10e-4,-0.15181 0.001,-0.1518 -1.04873,-1.04646 -1.04874,-1.04645 -0.23853,-0.15641 -0.23853,-0.15641 -1.9089,-0.0456 -1.9089,-0.0456 -0.33867,-0.17888 -0.33866,-0.17888 -0.46773,-0.53748 -0.46773,-0.53749 -1.21287,-1.46214 -1.21286,-1.46215 0.0481,-0.12535 0.0481,-0.12536 h 2.52729 2.52729 l 0.45987,0.13221 0.45986,0.1322 1.67216,1.70866 1.67217,1.70866 v -0.069 -0.069 l -0.22706,-0.39607 -0.22706,-0.39608 -0.42134,-0.7086 -0.42134,-0.7086 -0.0368,-0.39207 -0.0368,-0.39206 0.12467,-0.33867 0.12467,-0.33867 0.90281,-2.06436 0.9028,-2.06437 0.12555,-0.2428 0.12556,-0.2428 h 0.15087 0.15086 l 0.14089,0.3175 0.14089,0.3175 0.45421,0.80433 0.45422,0.80434 0.74233,1.34667 0.74234,1.34667 -0.0365,0.55833 -0.0365,0.55833 -0.30626,0.635 -0.30627,0.635 -0.63591,1.4762 -0.63592,1.4762 2.49776,2.49448 2.49776,2.49449 -0.025,0.47431 -0.025,0.47432 -0.77729,0.0243 -0.7773,0.0243 -1.43716,-1.43653 -1.43716,-1.43653 -0.56634,1.15826 -0.56635,1.15827 -0.26264,0.27516 -0.26264,0.27517 z"
         id="path3-7" /><path
         style="fill:#000000;fill-opacity:1"
         d="m 120.12274,144.9203 0.25643,-0.59266 0.21398,-0.43897 0.21398,-0.43897 -0.28246,-0.49421 -0.28246,-0.4942 -0.25308,-0.48168 -0.25308,-0.48169 -0.0612,0.0612 -0.0612,0.0612 -0.38419,0.917 -0.38419,0.91701 v 0.0806 0.0806 l 0.508,0.84579 0.508,0.8458 0.003,0.10285 0.003,0.10285 z"
         id="path10" /><path
         style="fill:#ffffff;fill-opacity:1"
         d="m 119.91828,145.72464 h -0.0999 l -0.58645,-0.99162 -0.58645,-0.99161 -0.032,-0.17255 -0.032,-0.17256 0.49365,-1.09988 0.49366,-1.09989 0.12573,-0.0242 0.12572,-0.0242 0.16599,0.31976 0.166,0.31977 0.4469,0.81856 0.44691,0.81856 -0.28742,0.6631 -0.28741,0.66311 -0.22655,0.48683 -0.22655,0.48684 z"
         id="path9" /><path
         style="fill:#000000;fill-opacity:1"
         d="m 114.81648,145.88919 0.75495,0.005 -0.0587,-0.0635 -0.0587,-0.0635 -0.68961,-0.69422 -0.6896,-0.69422 -0.43,-0.0529 -0.42999,-0.0529 -0.41059,0.0275 -0.41058,0.0275 0.56016,0.67733 0.56016,0.67733 0.27375,0.10106 0.27376,0.10105 z"
         id="path8" /><path
         style="fill:#ffffff;fill-opacity:1"
         d="m 114.88708,146.05062 -0.99483,-0.0127 -0.22995,-0.035 -0.22996,-0.035 -0.27804,-0.35186 -0.27805,-0.35187 -0.40217,-0.46029 -0.40216,-0.4603 v -0.12253 -0.12253 l 1.05678,0.0299 1.05678,0.0299 0.84822,0.84508 0.84821,0.84508 v 0.10742 0.10742 z"
         id="path7" /><path
         style="fill:#000000;fill-opacity:1"
         d="m 117.70242,152.75197 h 0.80072 l 0.17105,-0.3353 0.17106,-0.33529 v -0.0571 -0.0571 l -0.59206,0.0424 -0.59205,0.0424 -0.37972,0.35001 -0.37972,0.35002 z"
         id="path6" /><path
         style="fill:#ffffff;fill-opacity:1"
         d="m 117.65852,152.9213 h -1.01458 v -0.11472 -0.11472 l 0.4606,-0.43561 0.4606,-0.43561 h 0.76707 0.76707 v 0.12981 0.12981 l -0.2131,0.42052 -0.21309,0.42052 z"
         id="path5" /></g></g></svg>

`.trim();

// Pomocná funkce: udělá Leaflet ikonku se zvoleným pozadím
function makeShopIcon({ bg, planned=false }) {
  const size = 44; // ← ZDE MĚNÍŠ VELIKOST
  const dash = planned ? "outline:2px dashed rgba(0,0,0,.28); outline-offset:2px;" : "";

  return L.divIcon({
    className: "",
    html: `
      <div style="
        width:${size}px;
        height:${size}px;
        border-radius:12px;
        background:${bg};
        display:flex;
        align-items:center;
        justify-content:center;
        border:2px solid #fff;
        box-shadow:0 6px 20px rgba(0,0,0,.2);
        ${dash}
      ">
        <div style="width:70%; height:70%;">
          ${SHOP_SVG}
        </div>
      </div>
    `,
    iconSize: [size, size],
    iconAnchor: [size/2, size/2],
    popupAnchor: [0, -size/2]
  });
}

// Definice ikon pro stavy
const iconOpen   = makeShopIcon({ bg: "#22c55e" });
const iconClosed = makeShopIcon({ bg: "#0f0f0f" });
const iconPlanned = makeShopIcon({ bg: "#e5e7eb", planned: true });
;

    function makePopup(b) {
      if (b.planned) {
        return `
          <strong>${b.name}</strong><br/>
          ${b.addr}<br/>
          <span class="badge plan">Plánuje se</span><br/>
          <a href="${b.url}" target="_blank" rel="noopener">Více informací</a>
        `;
      }

      const st = isOpenNow(b.hours);
      const badge = st.state === "open"
        ? '<span class="badge open">Otevřeno</span>'
        : '<span class="badge closed">Zavřeno</span>';

      return `
        <strong>${b.name}</strong><br/>
        ${b.addr}<br/>
        ${badge} <span style="font-size:12px;color:#555">(${st.note})</span><br/>
        <a href="${b.url}" target="_blank" rel="noopener">Více informací</a>
      `;
    }

    function pickIcon(b) {
      if (b.planned) return iconPlanned;
      const st = isOpenNow(b.hours);
      return (st.state === "open") ? iconOpen : iconClosed;
    }

    // ====== MAPA ======
    const map = L.map("map", { scrollWheelZoom: false }).setView([49.8175, 15.4730], 7);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    const markers = [];
    const bounds = [];

    branches.forEach(b => {
      const marker = L.marker([b.lat, b.lng], { icon: pickIcon(b) })
        .addTo(map)
        .bindPopup(makePopup(b));

      markers.push({ b, marker });
      bounds.push([b.lat, b.lng]);
    });

    if (bounds.length) map.fitBounds(bounds, { padding: [30, 30] });

    // Přepočet stavů (otevřeno/zavřeno) každou minutu
    setInterval(() => {
      markers.forEach(({ b, marker }) => {
        marker.setIcon(pickIcon(b));
        marker.setPopupContent(makePopup(b));
      });
    }, 60 * 1000);
  </script>
</body>
</html>
